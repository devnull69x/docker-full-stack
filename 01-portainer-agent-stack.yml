version: '3.8'
  #docker secret create ganjaking.cloud.sslcert /mnt/certs/ganjaking.cloud.sslcert
  #docker secret create ganjaking.cloud.sslkey /mnt/certs/ganjaking.cloud.sslkey
  #docker secret create ganjaking.cloud.cacert /mnt/certs/ganjaking.cloud.cacert
services:

  agent:
    image: portainer/agent:2.10.0-alpine
    restart: always
    deploy:
      mode: global
    networks:
      - agent_network
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /mnt:/var/lib/docker/volumes

    portainer:
      image: portainer/portainer-ce:2.9.2
      restart: always
      deploy:
        mode: replicated
        replicas: 1
        placement:
          constraints: [node.role == manager]
      networks:
        - agent_network
      ports:
        - "10053:9443"
        - "9000:9000"
        - "8000:8000"
      volumes:
        - /mnt/portainer_data:/data
      command: -H tcp://tasks.agent:9001 --tlsskipverify --sslcert /run/secrets/ganjaking.cloud.sslcert --sslkey /run/secrets/ganjaking.cloud.sslkey
      secrets:
        - ganjaking.cloud.sslcert
        - ganjaking.cloud.sslkey

networks:
  agent_network:
    driver: overlay
    attachable: true

volumes:
  portainer_data:

secrets:
  ganjaking.cloud.sslcert:
    external: true
  ganjaking.cloud.sslkey:
    external: true
