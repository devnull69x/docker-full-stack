version: "3.8"

services:
  #created-in: portainer
  galera_etcd:
    image: quay.io/coreos/etcd:latest
    command: etcd
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints: [node.labels.name == unison-master]
        max_replicas_per_node: 1
    networks:
      - galera
    ports:
      - "2379:2379"
      - "2380:2380"
      - "4001:4001"
    volumes:
      - /usr/share/ca-certificates/:/etc/ssl/certs
    environment:
      - "ETCD_DATA_DIR=/opt/etc_data/"
      - "ETCD_NAME=etcd-node-01"
      - "ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379,http://0.0.0.0:4001"
      - "ETCD_ADVERTISE_CLIENT_URLS=http://pxc_galera_etcd:2379,http://pxc_galera_etcd:4001"
      - "ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380"
      - "ETCD_INITIAL_ADVERTISE_PEER_URLS=http://pxc_galera_etcd:2380"
      - "ETCD-INITIAL-CLUSTER=etcd0=http://pxc_galera_etcd:2380"
      - "ETCD_INITIAL_CLUSTER_STATE=new"
      - "ETCD_INITIAL_CLUSTER_TOKEN=etcd-cluster-1"

  proxysql:
    image: perconalab/proxysql:latest
    networks:
      - galera
    ports:
      - "6033:6033"
      - "6032:6032"
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints: [ node.labels.name == unison-master ]
        max_replicas_per_node: 1
    environment:
      CLUSTER_NAME: "galera-cluster"
      ETCD_HOST: "pxc_galera_etcd"
      DISCOVERY_SERVICE: "pxc_galera_etcd:2379"
      XTRABACKUP_PASSWORD: ${XTRABACKUP_PASSWORD}
      MYSQL_PROXY_USER: ${MYSQL_PROXY_USER}
      MYSQL_PROXY_PASSWORD: ${MYSQL_PROXY_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}

  percona-xtradb-master:
    image: percona/percona-xtradb-cluster:5.7
    networks:
      - galera
    volumes:
      - mysql-percona-master:/var/lib/mysql
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints: [ node.labels.name == unison-master ]
        max_replicas_per_node: 1
    environment:
      DISCOVERY_SERVICE: "pxc_galera_etcd:2379"
      CLUSTER_NAME: "galera-cluster"
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      XTRABACKUP_PASSWORD: ${XTRABACKUP_PASSWORD}

  percona-xtradab-cluster-0:
    image: percona/percona-xtradb-cluster:5.7
    networks:
      - galera
    volumes:
      - mysql-percona-cluster-0:/var/lib/mysql
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints: [ node.labels.name == unison-node-0 ]
        max_replicas_per_node: 1
    environment:
      DISCOVERY_SERVICE: "pxc_galera_etcd:2379"
      CLUSTER_NAME: "galera-cluster"
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      XTRABACKUP_PASSWORD: ${XTRABACKUP_PASSWORD}

  percona-xtradab-cluster-1:
    image: percona/percona-xtradb-cluster:5.7
    networks:
      - galera
    volumes:
      - mysql-percona-cluster-1:/var/lib/mysql
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints: [ node.labels.name == unison-node-1 ]
        max_replicas_per_node: 1
    environment:
      DISCOVERY_SERVICE: "pxc_galera_etcd:2379"
      CLUSTER_NAME: "galera-cluster"
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      XTRABACKUP_PASSWORD: ${XTRABACKUP_PASSWORD}

  percona-xtradab-cluster-2:
    image: percona/percona-xtradb-cluster:5.7
    networks:
      - galera
    volumes:
      - mysql-percona-cluster-2:/var/lib/mysql
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints: [ node.labels.name == unison-node-2 ]
        max_replicas_per_node: 1
    environment:
      DISCOVERY_SERVICE: "pxc_galera_etcd:2379"
      CLUSTER_NAME: "galera-cluster"
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      XTRABACKUP_PASSWORD: ${XTRABACKUP_PASSWORD}

  phpmyadmin:
    image: phpmyadmin/phpmyadmin:latest
    networks:
      - galera
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints: [ node.labels.name == unison-master ]
        max_replicas_per_node: 1
    links:
      - pxc_proxysql
    environment:
      PMA_ARBITRARY: 1
    restart: always
    ports:
      - "10052:80"

networks:
  galera:
    driver: overlay

volumes:
  mysql-percona-master:
    driver: local-persist
    driver_opts:
      mountpoint: /opt/mysql-percona-cluster-master
  mysql-percona-cluster-0:
    driver: local-persist
    driver_opts:
      mountpoint: /opt/mysql-percona-cluster-0
  mysql-percona-cluster-1:
    driver: local-persist
    driver_opts:
      mountpoint: /opt/mysql-percona-cluster-1
  mysql-percona-cluster-2:
    driver: local-persist
    driver_opts:
      mountpoint: /opt/mysql-percona-cluster-2